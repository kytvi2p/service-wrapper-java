From: Kill Your TV <killyourtv@i2pmail.org>
Date: Sun, 18 Nov 2012 10:33:13 +0000
Subject: kfreebsd support

---
 build.xml                           |  5 ++++-
 src/c/Makefile-kfreebsd-x86-32.make | 42 +++++++++++++++++++++++++++++++++++++
 src/c/Makefile-kfreebsd-x86-64.make | 42 +++++++++++++++++++++++++++++++++++++
 src/c/logger.c                      |  2 +-
 src/c/wrapper.c                     |  6 ++++--
 5 files changed, 93 insertions(+), 4 deletions(-)
 create mode 100644 src/c/Makefile-kfreebsd-x86-32.make
 create mode 100644 src/c/Makefile-kfreebsd-x86-64.make

--- a/build.xml
+++ b/build.xml
@@ -87,6 +87,9 @@
         <condition property="dist.os" value="freebsd">
             <equals arg1="${os.name}" arg2="FreeBSD"/>
         </condition>
+        <condition property="dist.os" value="kfreebsd">
+            <equals arg1="${os.name}" arg2="GNU/kFreeBSD"/>
+        </condition>
         <condition property="dist.os" value="irix">
             <equals arg1="${os.name}" arg2="Irix"/>
         </condition>
@@ -181,7 +184,7 @@
         
         <!-- Not all JVMs support the sun.arch.data.model property.  Default to 32-bit. -->
         <property name="sun.arch.data.model" value="32"/>
-        <condition property="bits-mismatch" value="true">
+        <condition property="bits-mismatch-DISABLED" value="true">
             <not>
                 <equals arg1="${sun.arch.data.model}" arg2="${bits}"/>
             </not>
--- /dev/null
+++ b/src/c/Makefile-kfreebsd-x86-32.make
@@ -0,0 +1,42 @@
+# Copyright (c) 1999, 2012 Tanuki Software, Ltd.
+# http://www.tanukisoftware.com
+# All rights reserved.
+#
+# This software is the proprietary information of Tanuki Software.
+# You shall use it only in accordance with the terms of the
+# license agreement you entered into with Tanuki Software.
+# http://wrapper.tanukisoftware.com/doc/english/licenseOverview.html
+
+CC = gcc -Wall -pedantic -DKFREEBSD -fPIC -I/usr/include -L/usr/lib -DUNICODE -D_UNICODE
+
+INCLUDE=$(JAVA_HOME)/include
+
+CFLAGS = -I$(INCLUDE) -I$(INCLUDE)/freebsd
+
+wrapper_SOURCE = wrapper.c wrapperinfo.c wrappereventloop.c wrapper_unix.c property.c logger.c wrapper_file.c wrapper_i18n.c wrapper_hashmap.c
+
+libwrapper_so_OBJECTS = wrapper_i18n.o wrapperjni_unix.o wrapperinfo.o wrapperjni.o
+
+BIN = ../../bin
+LIB = ../../lib
+
+all: init wrapper libwrapper.so
+
+clean:
+	rm -f *.o
+
+cleanall: clean
+	rm -rf *~ .deps
+	rm -f $(BIN)/wrapper $(LIB)/libwrapper.so
+
+init:
+	if test ! -d .deps; then mkdir .deps; fi
+
+wrapper: $(wrapper_SOURCE)
+	$(CC) $(wrapper_SOURCE) -lm -pthread -o $(BIN)/wrapper
+
+libwrapper.so: $(libwrapper_so_OBJECTS)
+	$(CC) -shared $(libwrapper_so_OBJECTS) -o $(LIB)/libwrapper.so
+
+#%.o: %.c
+#	$(COMPILE) -c $(DEFS) $<
--- /dev/null
+++ b/src/c/Makefile-kfreebsd-x86-64.make
@@ -0,0 +1,42 @@
+# Copyright (c) 1999, 2012 Tanuki Software, Ltd.
+# http://www.tanukisoftware.com
+# All rights reserved.
+#
+# This software is the proprietary information of Tanuki Software.
+# You shall use it only in accordance with the terms of the
+# license agreement you entered into with Tanuki Software.
+# http://wrapper.tanukisoftware.com/doc/english/licenseOverview.html
+
+CC = gcc -Wall -pedantic -DKFREEBSD -DJSW64 -fPIC -I/usr/include -L/usr/lib -DUNICODE -D_UNICODE
+
+INCLUDE=$(JAVA_HOME)/include
+
+CFLAGS = -I$(INCLUDE) -I$(INCLUDE)/freebsd
+
+wrapper_SOURCE = wrapper.c wrapperinfo.c wrappereventloop.c wrapper_unix.c property.c logger.c wrapper_file.c wrapper_i18n.c wrapper_hashmap.c
+
+libwrapper_so_OBJECTS = wrapper_i18n.o wrapperjni_unix.o wrapperinfo.o wrapperjni.o
+
+BIN = ../../bin
+LIB = ../../lib
+
+all: init wrapper libwrapper.so
+
+clean:
+	rm -f *.o
+
+cleanall: clean
+	rm -rf *~ .deps
+	rm -f $(BIN)/wrapper $(LIB)/libwrapper.so
+
+init:
+	if test ! -d .deps; then mkdir .deps; fi
+
+wrapper: $(wrapper_SOURCE)
+	$(CC) $(wrapper_SOURCE) -lm -pthread -o $(BIN)/wrapper
+
+libwrapper.so: $(libwrapper_so_OBJECTS)
+	$(CC) -shared $(libwrapper_so_OBJECTS) -o $(LIB)/libwrapper.so
+
+#%.o: %.c
+#	$(COMPILE) -c $(DEFS) $<
--- a/src/c/logger.c
+++ b/src/c/logger.c
@@ -76,7 +76,7 @@
  #elif defined(AIX) || defined(HPUX) || defined(MACOSX) || defined(OSF1)
  #elif defined(IRIX)
   #define PATH_MAX FILENAME_MAX
- #elif defined(FREEBSD)
+ #elif defined(FREEBSD) || defined(KFREEBSD)
   #include <sys/param.h>
   #include <errno.h>
  #else /* LINUX */
--- a/src/c/wrapper.c
+++ b/src/c/wrapper.c
@@ -98,7 +98,7 @@
  #elif defined(AIX) || defined(HPUX) || defined(MACOSX) || defined(OSF1)
  #elif defined(IRIX)
   #define PATH_MAX FILENAME_MAX
- #elif defined(FREEBSD)
+ #elif defined(FREEBSD) || defined(KFREEBSD)
   #include <sys/param.h>
   #include <errno.h>
  #else /* LINUX */
@@ -4619,7 +4619,7 @@
             log_printf(WRAPPER_SOURCE_WRAPPER, LEVEL_DEBUG, TEXT("Magic number for file %s: 0x%02x%02x%02x%02x"), filename, head[0], head[1], head[2], head[3]);
         }
 
-#if defined(LINUX) || defined(FREEBSD) || defined(SOLARIS) 
+#if defined(LINUX) || defined(FREEBSD) || defined(KFREEBSD) || defined(SOLARIS)
         if (head[1] == 'E' && head[2] == 'L' && head[3] == 'F') {
             return 1; /*ELF */
 #elif defined(AIX)
@@ -5913,6 +5913,8 @@
                               TEXT("wrapper.java.additional.auto_bits.solaris"),
 #elif defined(FREEBSD)
                               TEXT("wrapper.java.additional.auto_bits.freebsd"),
+#elif defined(KFREEBSD)
+                              TEXT("wrapper.java.additional.auto_bits.kfreebsd"),
 #elif defined(MACOSX)
                               TEXT("wrapper.java.additional.auto_bits.macosx"),
 #endif
